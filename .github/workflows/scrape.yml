name: Hourly Rate Scraper

on:
  workflow_dispatch: # cron-job.org triggers this every hour at :00 UTC

concurrency:
  group: scrape
  cancel-in-progress: false

jobs:
  scrape:
    runs-on: ubuntu-latest
    timeout-minutes: 20

    strategy:
      fail-fast: false
      matrix:
        include:
          - name: Indonesia IDR
            script: index.js
          - name: Thailand THB
            script: run-thb.js
          - name: Mongolia MNT
            script: run-mnt.js
          - name: Vietnam VND
            script: run-vnd.js
          - name: Nepal NPR
            script: run-npr.js
          - name: China CNY
            script: run-cny.js
          - name: Cambodia USD
            script: run-usd.js

    defaults:
      run:
        working-directory: scraper

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install dependencies
        run: npm install

      - name: Cache Playwright browsers
        id: playwright-cache
        uses: actions/cache@v4
        with:
          path: ~/.cache/ms-playwright
          key: playwright-chromium-${{ hashFiles('scraper/package-lock.json') }}

      - name: Install Playwright Chromium
        if: steps.playwright-cache.outputs.cache-hit != 'true'
        run: npx playwright install chromium --with-deps

      - name: Install Playwright system dependencies
        if: steps.playwright-cache.outputs.cache-hit == 'true'
        run: npx playwright install-deps chromium

      - name: Run scraper (${{ matrix.name }})
        env:
          SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          SUPABASE_SERVICE_KEY: ${{ secrets.SUPABASE_SERVICE_KEY }}
        run: node ${{ matrix.script }}
